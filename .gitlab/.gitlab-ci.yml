stages:
  - assets
  - test
  - deploy

cache:
  key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"

assets:
  image: node:12-buster-slim
  stage: assets
  script:
    - npm install
    - npm run build
    #- npx prettier --parser html --write ./public/*.html
    - mv ./public/build ./build
  artifacts:
    paths:
      - build
    expire_in: 1 day

pages:
  image: ruby:2.7
  stage: deploy
  script:
    - ./configure --env=prod --clean-before-tasks
    - bundle install
    - bundle exec jekyll build -d public --config _config.yml,_config_prod.yml
    - mv ./build ./public
  artifacts:
    paths:
      - public
  needs:
    - job: assets
      artifacts: true
  only:
    - main

test:
  image: ruby:2.7
  stage: deploy
  script:
    - ./configure --env=prod --clean-before-tasks
    - bundle install
    - bundle exec jekyll build -d public --config _config.yml
    - mv ./build ./public
  artifacts:
    paths:
      - public
  needs:
    - job: assets
      artifacts: true
  except:
    - main
